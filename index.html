<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRUPO INDUSTRIAL 4P - ERP</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #1e3c72; font-size: 28px; margin-bottom: 10px; }
        .logo p { color: #666; font-size: 14px; }
        
        .form-group { margin-bottom: 20px; }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #1e3c72; 
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary { background: #1e3c72; color: white; }
        .btn-primary:hover { background: #2a5298; }
        
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            display: none;
            padding: 10px;
            background: #fdeaea;
            border-radius: 5px;
        }
        
        .hidden { display: none !important; }
        
        .dashboard {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: #f5f6fa;
        }
        
        .sidebar {
            width: 260px;
            background: #1e3c72;
            color: white;
            position: fixed;
            height: 100vh;
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar h2 { 
            margin-bottom: 30px; 
            font-size: 20px; 
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .sidebar nav ul { list-style: none; }
        
        .sidebar nav ul li { margin-bottom: 5px; }
        
        .sidebar nav ul li a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 12px 15px;
            border-radius: 5px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .sidebar nav ul li a:hover, .sidebar nav ul li a.active {
            background: rgba(255,255,255,0.2);
        }
        
        .main-content {
            margin-left: 260px;
            padding: 30px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { color: #1e3c72; }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .stat-card:hover { transform: translateY(-5px); }
        
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .number { color: #1e3c72; font-size: 28px; font-weight: bold; }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h3 { color: #1e3c72; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th { 
            background: #f8f9fa; 
            color: #1e3c72; 
            font-weight: 600; 
            position: sticky;
            top: 0;
        }
        
        tr:hover { background: #f8f9fa; }
        
        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input { flex: 1; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        
        .close:hover { color: #333; }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group label { 
            font-size: 14px; 
            margin-bottom: 5px; 
            color: #555;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .total-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            color: #1e3c72;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
            font-weight: 600;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .activity-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 10px;
            border-left: 3px solid #1e3c72;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 0 5px 5px 0;
        }
        
        .activity-item small {
            color: #999;
            display: block;
            margin-top: 5px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.info { background: #3498db; }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-bar select, .filter-bar input {
            width: auto;
            min-width: 150px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .low-stock { color: #e74c3c; font-weight: bold; }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        @media print {
            .sidebar, .header button, .actions, .search-box { display: none !important; }
            .main-content { margin-left: 0; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="logo">
            <h1>üè≠ GRUPO INDUSTRIAL 4P</h1>
            <p>Sistema de Gesti√≥n Empresarial</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label>Correo Electr√≥nico</label>
                <input type="email" id="email" required placeholder="usuario@gpo-industrial-4p.com">
            </div>
            
            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <button type="submit" class="btn-primary" style="width: 100%;">Iniciar Sesi√≥n</button>
        </form>
        
        <div id="errorMsg" class="error-message">
            Credenciales incorrectas. Intente nuevamente.
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardScreen" class="dashboard">
        <div class="sidebar">
            <h2>üè≠ GRUPO INDUSTRIAL 4P</h2>
            <nav>
                <ul>
                    <li><a onclick="showSection('inicio')" id="nav-inicio" class="active">üè† Inicio</a></li>
                    <li><a onclick="showSection('inventario')" id="nav-inventario">üì¶ Inventario</a></li>
                    <li><a onclick="showSection('ventas')" id="nav-ventas">üí∞ Ventas</a></li>
                    <li><a onclick="showSection('compras')" id="nav-compras">üõí Compras</a></li>
                    <li><a onclick="showSection('clientes')" id="nav-clientes">üë• Clientes</a></li>
                    <li><a onclick="showSection('proveedores')" id="nav-proveedores">üöö Proveedores</a></li>
                    <li><a onclick="showSection('reportes')" id="nav-reportes">üìä Reportes</a></li>
                    <li><a onclick="showSection('config')" id="nav-config">‚öôÔ∏è Configuraci√≥n</a></li>
                </ul>
            </nav>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">Panel de Control</h1>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="userDisplay" style="color: #666;"></span>
                    <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- INICIO -->
            <div id="inicio" class="section active">
                <div class="stats-grid">
                    <div class="stat-card" onclick="showSection('ventas')">
                        <h3>üí∞ Ventas del Mes</h3>
                        <div class="number" id="totalVentas">$0.00</div>
                    </div>
                    <div class="stat-card" onclick="showSection('compras')">
                        <h3>üõí Compras del Mes</h3>
                        <div class="number" id="totalCompras">$0.00</div>
                    </div>
                    <div class="stat-card" onclick="showSection('inventario')">
                        <h3>üì¶ Productos</h3>
                        <div class="number" id="totalProductos">0</div>
                    </div>
                    <div class="stat-card" onclick="showSection('clientes')">
                        <h3>üë• Clientes</h3>
                        <div class="number" id="totalClientes">0</div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>üìà Ventas vs Compras</h3>
                        <div class="chart-container">
                            <canvas id="chartVentasCompras"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>üìä Productos por Categor√≠a</h3>
                        <div class="chart-container">
                            <canvas id="chartCategorias"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>üíµ Estado de Resultados</h3>
                        <div class="chart-container">
                            <canvas id="chartFinanciero"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>üìâ Stock de Inventario</h3>
                        <div class="chart-container">
                            <canvas id="chartStock"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üìà Actividad Reciente</h3>
                        <div class="activity-list" id="activityList">
                            <div class="empty-state">No hay actividad reciente</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>‚ö†Ô∏è Stock Bajo</h3>
                        <div id="lowStockList">
                            <div class="empty-state">No hay productos con stock bajo</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INVENTARIO -->
            <div id="inventario" class="section">
                <div class="card">
                    <h3>
                        üì¶ Gesti√≥n de Inventario
                        <button class="btn-success" onclick="openModal('producto')">‚ûï Nuevo Producto</button>
                    </h3>
                    
                    <div class="search-box">
                        <input type="text" id="searchProducto" placeholder="Buscar por nombre o c√≥digo..." onkeyup="filterTable('productos')">
                        <select id="filterCategoria" onchange="filterTable('productos')">
                            <option value="">Todas las categor√≠as</option>
                        </select>
                        <button class="btn-primary" onclick="exportData('productos')">üì• Exportar</button>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="tablaProductos">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Producto</th>
                                    <th>Categor√≠a</th>
                                    <th>Stock</th>
                                    <th>Stock M√≠n.</th>
                                    <th>Costo</th>
                                    <th>Precio</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VENTAS -->
            <div id="ventas" class="section">
                <div class="card">
                    <h3>
                        üí∞ √ìrdenes de Venta
                        <button class="btn-success" onclick="openModal('venta')">‚ûï Nueva Venta</button>
                    </h3>
                    
                    <div class="filter-bar">
                        <input type="text" id="searchVenta" placeholder="Buscar..." onkeyup="filterTable('ventas')">
                        <select id="filterEstadoVenta" onchange="filterTable('ventas')">
                            <option value="">Todos los estados</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Pagado</option>
                            <option value="Enviado">Enviado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                        <input type="date" id="filterFechaDesde" onchange="filterTable('ventas')">
                        <input type="date" id="filterFechaHasta" onchange="filterTable('ventas')">
                    </div>
                    
                    <table id="tablaVentas">
                        <thead>
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Productos</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <div class="total-box">
                        Total ventas filtradas: <span id="totalVentasFiltradas">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- COMPRAS -->
            <div id="compras" class="section">
                <div class="card">
                    <h3>
                        üõí √ìrdenes de Compra
                        <button class="btn-success" onclick="openModal('compra')">‚ûï Nueva Compra</button>
                    </h3>
                    
                    <div class="filter-bar">
                        <input type="text" id="searchCompra" placeholder="Buscar..." onkeyup="filterTable('compras')">
                        <select id="filterEstadoCompra" onchange="filterTable('compras')">
                            <option value="">Todos los estados</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Recibido">Recibido</option>
                        </select>
                    </div>
                    
                    <table id="tablaCompras">
                        <thead>
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>Productos</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <div class="total-box">
                        Total compras filtradas: <span id="totalComprasFiltradas">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="clientes" class="section">
                <div class="card">
                    <h3>
                        üë• Directorio de Clientes
                        <button class="btn-success" onclick="openModal('cliente')">‚ûï Nuevo Cliente</button>
                    </h3>
                    
                    <div class="search-box">
                        <input type="text" id="searchCliente" placeholder="Buscar cliente..." onkeyup="filterTable('clientes')">
                        <button class="btn-primary" onclick="exportData('clientes')">üì• Exportar</button>
                    </div>
                    
                    <table id="tablaClientes">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Contacto</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>L√≠mite Cr√©dito</th>
                                <th>Saldo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- PROVEEDORES -->
            <div id="proveedores" class="section">
                <div class="card">
                    <h3>
                        üöö Proveedores
                        <button class="btn-success" onclick="openModal('proveedor')">‚ûï Nuevo Proveedor</button>
                    </h3>
                    
                    <div class="search-box">
                        <input type="text" id="searchProveedor" placeholder="Buscar proveedor..." onkeyup="filterTable('proveedores')">
                    </div>
                    
                    <table id="tablaProveedores">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Empresa</th>
                                <th>Contacto</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Direcci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTES -->
            <div id="reportes" class="section">
                <div class="tabs">
                    <div class="tab active" onclick="showReportTab('resumen')">Resumen</div>
                    <div class="tab" onclick="showReportTab('ventas')">Ventas</div>
                    <div class="tab" onclick="showReportTab('inventario')">Inventario</div>
                    <div class="tab" onclick="showReportTab('financiero')">Financiero</div>
                </div>
                
                <div id="report-resumen" class="report-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Utilidad Bruta</h3>
                            <div class="number" id="utilidadBruta">$0.00</div>
                        </div>
                        <div class="stat-card">
                            <h3>Margen de Ganancia</h3>
                            <div class="number" id="margenGanancia">0%</div>
                        </div>
                        <div class="stat-card">
                            <h3>Rotaci√≥n de Inventario</h3>
                            <div class="number" id="rotacionInventario">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Ticket Promedio</h3>
                            <div class="number" id="ticketPromedio">$0.00</div>
                        </div>
                    </div>
                    
                    <div class="chart-grid">
                        <div class="chart-card">
                            <h3>üìà Tendencia de Ventas</h3>
                            <div class="chart-container">
                                <canvas id="chartTendencia"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>ü•ß Distribuci√≥n de Ventas por Categor√≠a</h3>
                            <div class="chart-container">
                                <canvas id="chartPieVentas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="report-ventas" class="report-section" style="display: none;">
                    <div class="card">
                        <h3>üìà An√°lisis de Ventas</h3>
                        <div class="export-buttons">
                            <button class="btn-primary" onclick="generateReport('ventas')">üìÑ Generar PDF</button>
                            <button class="btn-success" onclick="exportData('reporteVentas')">üìä Exportar Excel</button>
                        </div>
                        <table id="tablaReporteVentas">
                            <thead>
                                <tr>
                                    <th>Per√≠odo</th>
                                    <th>No. Ventas</th>
                                    <th>Total</th>
                                    <th>Promedio</th>
                                    <th>Crecimiento</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="report-inventario" class="report-section" style="display: none;">
                    <div class="card">
                        <h3>üì¶ Valoraci√≥n de Inventario</h3>
                        <div class="export-buttons">
                            <button class="btn-primary" onclick="generateReport('inventario')">üìÑ Generar PDF</button>
                        </div>
                        <table id="tablaReporteInventario">
                            <thead>
                                <tr>
                                    <th>Categor√≠a</th>
                                    <th>Productos</th>
                                    <th>Stock Total</th>
                                    <th>Valor Costo</th>
                                    <th>Valor Venta</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="total-box">
                            Valor total del inventario: <span id="valorTotalInventario">$0.00</span>
                        </div>
                    </div>
                </div>
                
                <div id="report-financiero" class="report-section" style="display: none;">
                    <div class="card">
                        <h3>üíµ Estado de Resultados</h3>
                        <table>
                            <tr>
                                <td><strong>Ventas Totales</strong></td>
                                <td style="text-align: right;" id="finVentas">$0.00</td>
                            </tr>
                            <tr>
                                <td><strong>Costo de Ventas</strong></td>
                                <td style="text-align: right;" id="finCostos">$0.00</td>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <td><strong>Utilidad Bruta</strong></td>
                                <td style="text-align: right;" id="finUtilidad">$0.00</td>
                            </tr>
                            <tr>
                                <td>Gastos Operativos</td>
                                <td style="text-align: right;" id="finGastos">$0.00</td>
                            </tr>
                            <tr style="background: #e8f4f8;">
                                <td><strong>Utilidad Neta</strong></td>
                                <td style="text-align: right;" id="finNeto">$0.00</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CONFIGURACI√ìN -->
            <div id="config" class="section">
                <div class="card">
                    <h3>‚öôÔ∏è Configuraci√≥n General</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre de la Empresa</label>
                            <input type="text" id="configNombreEmpresa" value="GRUPO INDUSTRIAL 4P">
                        </div>
                        <div class="form-group">
                            <label>RFC</label>
                            <input type="text" id="configRFC" value="GIP040512ABC">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Direcci√≥n</label>
                            <input type="text" id="configDireccion" value="Av. Industrial #123">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="text" id="configTelefono" value="555-123-4567">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email de Contacto</label>
                            <input type="email" id="configEmail" value="contacto@gpo-industrial-4p.com">
                        </div>
                        <div class="form-group">
                            <label>Impuesto (%)</label>
                            <input type="number" id="configImpuesto" value="16">
                        </div>
                    </div>
                    <button class="btn-success" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                </div>
                
                <div class="card">
                    <h3>üë• Gesti√≥n de Usuarios</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tablaUsuarios"></tbody>
                    </table>
                    <p style="color: #666; margin-top: 15px; font-size: 14px;">
                        Los usuarios solo pueden ser modificados por el administrador del sistema.
                    </p>
                </div>
                
                <div class="card">
                    <h3>üíæ Gesti√≥n de Datos</h3>
                    <div class="export-buttons">
                        <button class="btn-primary" onclick="backupData()">üíæ Crear Respaldo</button>
                        <button class="btn-warning" onclick="document.getElementById('restoreFile').click()">üìÇ Restaurar Datos</button>
                        <input type="file" id="restoreFile" style="display: none;" accept=".json" onchange="restoreData(this)">
                        <button class="btn-danger" onclick="clearAllData()">üóëÔ∏è Borrar Todos los Datos</button>
                    </div>
                    <p style="color: #666; margin-top: 10px; font-size: 14px;">
                        Los datos se guardan autom√°ticamente en tu navegador. Usa "Crear Respaldo" para descargar un archivo de seguridad.
                    </p>
                </div>
            </div>

        </div>
    </div>

    <!-- MODALES -->
    
    <!-- Modal Producto -->
    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('producto')">&times;</span>
            <h3 id="tituloProducto">Nuevo Producto</h3>
            <form id="formProducto" onsubmit="saveProducto(event)">
                <input type="hidden" id="prodId">
                <div class="form-row">
                    <div class="form-group">
                        <label>C√≥digo *</label>
                        <input type="text" id="prodCodigo" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="prodNombre" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Categor√≠a *</label>
                        <select id="prodCategoria" required>
                            <option value="">Seleccionar...</option>
                            <option value="Ferreter√≠a">Ferreter√≠a</option>
                            <option value="El√©ctrico">El√©ctrico</option>
                            <option value="Plomer√≠a">Plomer√≠a</option>
                            <option value="Herramientas">Herramientas</option>
                            <option value="Pintura">Pintura</option>
                            <option value="Maquinado">Maquinado</option>
                            <option value="Ensamble">Ensamble</option>
                            <option value="Acabado">Acabado</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Unidad</label>
                        <select id="prodUnidad">
                            <option value="Pieza">Pieza</option>
                            <option value="Caja">Caja</option>
                            <option value="Metro">Metro</option>
                            <option value="Kg">Kg</option>
                            <option value="Litro">Litro</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Stock Inicial *</label>
                        <input type="number" id="prodStock" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Stock M√≠nimo</label>
                        <input type="number" id="prodStockMin" min="0" value="10">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Costo Unitario *</label>
                        <input type="number" id="prodCosto" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Precio Venta *</label>
                        <input type="number" id="prodPrecio" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="prodDescripcion" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-success">Guardar Producto</button>
                <button type="button" class="btn-secondary" onclick="closeModal('producto')">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal Venta -->
    <div id="modalVenta" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('venta')">&times;</span>
            <h3>Nueva Venta</h3>
            <form id="formVenta" onsubmit="saveVenta(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select id="ventaCliente" required>
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="ventaFecha" required>
                    </div>
                </div>
                
                <div class="card" style="background: #f8f9fa;">
                    <h4>üõí Productos</h4>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Producto</label>
                            <select id="ventaProdSelect" onchange="updatePrecioVenta()">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" id="ventaCantidad" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label>Precio</label>
                            <input type="number" id="ventaPrecio" readonly>
                        </div>
                        <div class="form-group">
                            <label style="visibility: hidden;">Acci√≥n</label>
                            <button type="button" class="btn-success" onclick="addProductoVenta()">‚ûï Agregar</button>
                        </div>
                    </div>
                    
                    <table id="tablaProductosVenta">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Subtotal</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <div class="total-box">
                        Total: <span id="ventaTotal">$0.00</span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="ventaEstado">
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Pagado</option>
                            <option value="Enviado">Enviado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>M√©todo de Pago</label>
                        <select id="ventaMetodoPago">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Cr√©dito">Cr√©dito</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="ventaNotas" rows="2"></textarea>
                </div>
                
                <button type="submit" class="btn-success">üíæ Guardar Venta</button>
                <button type="button" class="btn-secondary" onclick="closeModal('venta')">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal Compra -->
    <div id="modalCompra" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('compra')">&times;</span>
            <h3>Nueva Compra</h3>
            <form id="formCompra" onsubmit="saveCompra(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Proveedor *</label>
                        <select id="compraProveedor" required>
                            <option value="">Seleccionar proveedor...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="compraFecha" required>
                    </div>
                </div>
                
                <div class="card" style="background: #f8f9fa;">
                    <h4>üõí Productos</h4>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Producto</label>
                            <select id="compraProdSelect">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" id="compraCantidad" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label>Costo Unit.</label>
                            <input type="number" id="compraCosto" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label style="visibility: hidden;">Acci√≥n</label>
                            <button type="button" class="btn-success" onclick="addProductoCompra()">‚ûï Agregar</button>
                        </div>
                    </div>
                    
                    <table id="tablaProductosCompra">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Costo</th>
                                <th>Subtotal</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <div class="total-box">
                        Total: <span id="compraTotal">$0.00</span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="compraEstado">
                            <option value="Pendiente">Pendiente</option>
                            <option value="Recibido">Recibido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Factura</label>
                        <input type="text" id="compraFactura" placeholder="No. de factura">
                    </div>
                </div>
                
                <button type="submit" class="btn-success">üíæ Guardar Compra</button>
                <button type="button" class="btn-secondary" onclick="closeModal('compra')">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('cliente')">&times;</span>
            <h3 id="tituloCliente">Nuevo Cliente</h3>
            <form id="formCliente" onsubmit="saveCliente(event)">
                <input type="hidden" id="cliId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="cliNombre" required>
                    </div>
                    <div class="form-group">
                        <label>RFC</label>
                        <input type="text" id="cliRFC">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Contacto</label>
                        <input type="text" id="cliContacto">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono *</label>
                        <input type="tel" id="cliTelefono" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="cliEmail">
                    </div>
                    <div class="form-group">
                        <label>L√≠mite de Cr√©dito</label>
                        <input type="number" id="cliCredito" min="0" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Direcci√≥n</label>
                    <textarea id="cliDireccion" rows="2"></textarea>
                </div>
                <button type="submit" class="btn-success">Guardar Cliente</button>
                <button type="button" class="btn-secondary" onclick="closeModal('cliente')">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal Proveedor -->
    <div id="modalProveedor" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('proveedor')">&times;</span>
            <h3 id="tituloProveedor">Nuevo Proveedor</h3>
            <form id="formProveedor" onsubmit="saveProveedor(event)">
                <input type="hidden" id="provId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Empresa *</label>
                        <input type="text" id="provEmpresa" required>
                    </div>
                    <div class="form-group">
                        <label>RFC</label>
                        <input type="text" id="provRFC">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Contacto</label>
                        <input type="text" id="provContacto">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono *</label>
                        <input type="tel" id="provTelefono" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="provEmail">
                    </div>
                    <div class="form-group">
                        <label>D√≠as de Cr√©dito</label>
                        <input type="number" id="provDiasCredito" min="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Direcci√≥n</label>
                    <textarea id="provDireccion" rows="2"></textarea>
                </div>
                <button type="submit" class="btn-success">Guardar Proveedor</button>
                <button type="button" class="btn-secondary" onclick="closeModal('proveedor')">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        // ==================== BASE DE DATOS ====================
        
        const DB = {
            usuarios: [
                { email: 'gerente@gpo-industrial-4p.com', password: '253406', nombre: 'Gerente General', rol: 'admin' },
                { email: 'ensamble/acabado@gpo-industrial-4p.com', password: '546515', nombre: 'Ensamble/Acabado', rol: 'produccion' },
                { email: 'compras@gpo-industrial-4p.com', password: '165435', nombre: 'Departamento de Compras', rol: 'compras' },
                { email: 'ingenieria@gpo-industrial-4p.com', password: '646152', nombre: 'Ingenier√≠a', rol: 'tecnico' },
                { email: 'direccion@gpo-industrial-4p.com', password: '681456', nombre: 'Direcci√≥n', rol: 'direccion' },
                { email: 'maquinado@gpo-industrial-4p.com', password: '814654', nombre: 'Maquinado', rol: 'produccion' }
            ],
            productos: [],
            clientes: [],
            proveedores: [],
            ventas: [],
            compras: [],
            config: {
                nombreEmpresa: 'GRUPO INDUSTRIAL 4P',
                rfc: 'GIP040512ABC',
                direccion: 'Av. Industrial #123',
                telefono: '555-123-4567',
                email: 'contacto@gpo-industrial-4p.com',
                impuesto: 16
            },
            actividad: []
        };

        let productosVentaTemp = [];
        let productosCompraTemp = [];
        let currentUser = null;
        let charts = {};

        // ==================== INICIALIZACI√ìN ====================

        function init() {
            loadData();
            updateDashboard();
            populateSelects();
            renderAllTables();
            renderUsuarios();
            
            document.getElementById('ventaFecha').valueAsDate = new Date();
            document.getElementById('compraFecha').valueAsDate = new Date();
        }

        function loadData() {
            const saved = localStorage.getItem('erp_data_gpo4p');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(DB, data);
            } else {
                addDemoData();
            }
        }

        function saveData() {
            localStorage.setItem('erp_data_gpo4p', JSON.stringify(DB));
        }

        function addDemoData() {
            DB.productos = [
                { id: 1, codigo: 'PRD-001', nombre: 'Tornillos Hexagonales 1/4', categoria: 'Ferreter√≠a', unidad: 'Caja', stock: 50, stockMin: 10, costo: 45.00, precio: 65.00, descripcion: 'Caja con 100 piezas' },
                { id: 2, codigo: 'PRD-002', nombre: 'Cable El√©ctrico 12 AWG', categoria: 'El√©ctrico', unidad: 'Metro', stock: 200, stockMin: 50, costo: 12.50, precio: 18.00, descripcion: 'Rojo' },
                { id: 3, codigo: 'PRD-003', nombre: 'Llave Ajustable 10"', categoria: 'Herramientas', unidad: 'Pieza', stock: 15, stockMin: 5, costo: 120.00, precio: 180.00, descripcion: 'Cromada' },
                { id: 4, codigo: 'PRD-004', nombre: 'Pintura Blanca 4L', categoria: 'Pintura', unidad: 'Litro', stock: 8, stockMin: 10, costo: 280.00, precio: 380.00, descripcion: 'Esmalte' },
                { id: 5, codigo: 'PRD-005', nombre: 'Tubo PVC 1/2"', categoria: 'Plomer√≠a', unidad: 'Metro', stock: 100, stockMin: 20, costo: 15.00, precio: 25.00, descripcion: 'Presi√≥n' }
            ];

            DB.clientes = [
                { id: 1, nombre: 'Constructora del Norte', rfc: 'CDN123456ABC', contacto: 'Juan P√©rez', telefono: '555-0101', email: 'juan@cdn.com', credito: 50000, saldo: 12500, direccion: 'Av. Industrial 100' },
                { id: 2, nombre: 'Ferreter√≠a La Esquina', rfc: 'FLE987654XYZ', contacto: 'Mar√≠a L√≥pez', telefono: '555-0202', email: 'maria@ferre.com', credito: 25000, saldo: 0, direccion: 'Calle Principal 50' },
                { id: 3, nombre: 'Taller Mec√°nico Speed', rfc: 'TMS456789DEF', contacto: 'Carlos Ruiz', telefono: '555-0303', email: 'carlos@speed.com', credito: 15000, saldo: 3200, direccion: 'Blvd. Automotriz 200' }
            ];

            DB.proveedores = [
                { id: 1, empresa: 'Ferreter√≠a Mayorista SA', rfc: 'FMA111222ABC', contacto: 'Pedro G√≥mez', telefono: '555-1001', email: 'pedro@fma.com', diasCredito: 30, direccion: 'Zona Industrial Norte' },
                { id: 2, empresa: 'El√©ctricos del Centro', rfc: 'EDC333444XYZ', contacto: 'Ana Mart√≠nez', telefono: '555-1002', email: 'ana@edc.com', diasCredito: 15, direccion: 'Av. Tecnolog√≠a 300' },
                { id: 3, empresa: 'Herramientas Pro', rfc: 'HPR555666DEF', contacto: 'Luis Hern√°ndez', telefono: '555-1003', email: 'luis@hpro.com', diasCredito: 45, direccion: 'Parque Industrial Sur' }
            ];

            DB.ventas = [
                { id: 1, folio: 'VT-2026-001', fecha: '2026-02-15', clienteId: 1, productos: [{productoId: 1, cantidad: 2, precio: 65}, {productoId: 2, cantidad: 10, precio: 18}], total: 310, estado: 'Pagado', metodoPago: 'Transferencia', notas: '' },
                { id: 2, folio: 'VT-2026-002', fecha: '2026-02-17', clienteId: 2, productos: [{productoId: 3, cantidad: 1, precio: 180}], total: 180, estado: 'Pendiente', metodoPago: 'Efectivo', notas: '' },
                { id: 3, folio: 'VT-2026-003', fecha: '2026-02-18', clienteId: 3, productos: [{productoId: 1, cantidad: 5, precio: 65}, {productoId: 5, cantidad: 20, precio: 25}], total: 825, estado: 'Pagado', metodoPago: 'Tarjeta', notas: '' }
            ];

            DB.compras = [
                { id: 1, folio: 'OC-2026-001', fecha: '2026-02-10', proveedorId: 1, productos: [{productoId: 1, cantidad: 20, costo: 45}, {productoId: 3, cantidad: 10, costo: 120}], total: 2100, estado: 'Recibido', factura: 'F-1234' },
                { id: 2, folio: 'OC-2026-002', fecha: '2026-02-16', proveedorId: 2, productos: [{productoId: 2, cantidad: 100, costo: 12.5}], total: 1250, estado: 'Recibido', factura: 'A-5678' }
            ];

            addActivity('Sistema inicializado - GRUPO INDUSTRIAL 4P');
            saveData();
        }

        // ==================== LOGIN ====================

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            
            const user = DB.usuarios.find(u => u.email.toLowerCase() === email && u.password === password);
            
            if (user) {
                currentUser = user;
                document.getElementById('errorMsg').style.display = 'none';
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardScreen').style.display = 'block';
                document.getElementById('userDisplay').textContent = user.nombre + ' (' + user.rol + ')';
                
                init();
                addActivity(`Inicio de sesi√≥n: ${user.nombre} (${user.rol})`);
                showNotification('Bienvenido ' + user.nombre, 'success');
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        });

        function logout() {
            if (currentUser) {
                addActivity(`Cierre de sesi√≥n: ${currentUser.nombre}`);
            }
            currentUser = null;
            localStorage.removeItem('erp_session');
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            showNotification('Sesi√≥n cerrada', 'info');
        }

        // ==================== NAVEGACI√ìN ====================

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar nav ul li a').forEach(a => a.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            document.getElementById('nav-' + sectionId).classList.add('active');
            
            const titles = {
                'inicio': 'Panel de Control',
                'inventario': 'Gesti√≥n de Inventario',
                'ventas': '√ìrdenes de Venta',
                'compras': '√ìrdenes de Compra',
                'clientes': 'Directorio de Clientes',
                'proveedores': 'Proveedores',
                'reportes': 'Reportes y Estad√≠sticas',
                'config': 'Configuraci√≥n del Sistema'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId];
            
            if (sectionId === 'reportes') {
                updateReportes();
            }
            
            if (sectionId === 'inicio') {
                setTimeout(initCharts, 100);
            }
        }

        // ==================== MODALES ====================

        function openModal(tipo, id = null) {
            document.getElementById('modal' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).style.display = 'block';
            
            if (tipo === 'venta') {
                productosVentaTemp = [];
                renderProductosVenta();
                populateSelects();
            } else if (tipo === 'compra') {
                productosCompraTemp = [];
                renderProductosCompra();
                populateSelects();
            }
            
            if (id) {
                loadDataForEdit(tipo, id);
            } else {
                document.getElementById('form' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).reset();
                document.getElementById(tipo === 'cliente' ? 'cliId' : tipo === 'proveedor' ? 'provId' : 'prodId').value = '';
                document.getElementById('titulo' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).textContent = 'Nuevo ' + tipo.charAt(0).toUpperCase() + tipo.slice(1);
            }
        }

        function closeModal(tipo) {
            document.getElementById('modal' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).style.display = 'none';
        }

        function loadDataForEdit(tipo, id) {
            if (tipo === 'producto') {
                const p = DB.productos.find(p => p.id == id);
                document.getElementById('prodId').value = p.id;
                document.getElementById('prodCodigo').value = p.codigo;
                document.getElementById('prodNombre').value = p.nombre;
                document.getElementById('prodCategoria').value = p.categoria;
                document.getElementById('prodUnidad').value = p.unidad;
                document.getElementById('prodStock').value = p.stock;
                document.getElementById('prodStockMin').value = p.stockMin;
                document.getElementById('prodCosto').value = p.costo;
                document.getElementById('prodPrecio').value = p.precio;
                document.getElementById('prodDescripcion').value = p.descripcion || '';
                document.getElementById('tituloProducto').textContent = 'Editar Producto';
            }
        }

        // ==================== PRODUCTOS ====================

        function saveProducto(e) {
            e.preventDefault();
            
            const id = document.getElementById('prodId').value;
            const producto = {
                id: id ? parseInt(id) : Date.now(),
                codigo: document.getElementById('prodCodigo').value,
                nombre: document.getElementById('prodNombre').value,
                categoria: document.getElementById('prodCategoria').value,
                unidad: document.getElementById('prodUnidad').value,
                stock: parseInt(document.getElementById('prodStock').value),
                stockMin: parseInt(document.getElementById('prodStockMin').value),
                costo: parseFloat(document.getElementById('prodCosto').value),
                precio: parseFloat(document.getElementById('prodPrecio').value),
                descripcion: document.getElementById('prodDescripcion').value
            };
            
            if (id) {
                const index = DB.productos.findIndex(p => p.id == id);
                DB.productos[index] = producto;
                addActivity(`Producto actualizado: ${producto.nombre} por ${currentUser.nombre}`);
            } else {
                DB.productos.push(producto);
                addActivity(`Producto creado: ${producto.nombre} por ${currentUser.nombre}`);
            }
            
            saveData();
            renderProductos();
            closeModal('producto');
            updateDashboard();
            showNotification('Producto guardado correctamente', 'success');
        }

        function editProducto(id) {
            loadDataForEdit('producto', id);
            openModal('producto');
        }

        function deleteProducto(id) {
            if (confirm('¬øEliminar este producto?')) {
                const p = DB.productos.find(p => p.id == id);
                DB.productos = DB.productos.filter(p => p.id != id);
                saveData();
                renderProductos();
                updateDashboard();
                addActivity(`Producto eliminado: ${p.nombre} por ${currentUser.nombre}`);
                showNotification('Producto eliminado', 'info');
            }
        }

        // ==================== VENTAS ====================

        function updatePrecioVenta() {
            const prodId = document.getElementById('ventaProdSelect').value;
            if (prodId) {
                const prod = DB.productos.find(p => p.id == prodId);
                document.getElementById('ventaPrecio').value = prod.precio;
            }
        }

        function addProductoVenta() {
            const prodId = document.getElementById('ventaProdSelect').value;
            const cantidad = parseInt(document.getElementById('ventaCantidad').value);
            const precio = parseFloat(document.getElementById('ventaPrecio').value);
            
            if (!prodId || !cantidad || !precio) {
                showNotification('Selecciona producto, cantidad y precio', 'error');
                return;
            }
            
            const prod = DB.productos.find(p => p.id == prodId);
            
            if (cantidad > prod.stock) {
                showNotification(`Stock insuficiente. Disponible: ${prod.stock}`, 'error');
                return;
            }
            
            productosVentaTemp.push({
                productoId: parseInt(prodId),
                nombre: prod.nombre,
                cantidad: cantidad,
                precio: precio
            });
            
            renderProductosVenta();
            document.getElementById('ventaProdSelect').value = '';
            document.getElementById('ventaCantidad').value = 1;
            document.getElementById('ventaPrecio').value = '';
        }

        function removeProductoVenta(index) {
            productosVentaTemp.splice(index, 1);
            renderProductosVenta();
        }

        function renderProductosVenta() {
            const tbody = document.querySelector('#tablaProductosVenta tbody');
            tbody.innerHTML = '';
            let total = 0;
            
            productosVentaTemp.forEach((item, index) => {
                const subtotal = item.cantidad * item.precio;
                total += subtotal;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.nombre}</td>
                        <td>${item.cantidad}</td>
                        <td>$${item.precio.toFixed(2)}</td>
                        <td>$${subtotal.toFixed(2)}</td>
                        <td><button type="button" class="btn-danger btn-small" onclick="removeProductoVenta(${index})">üóëÔ∏è</button></td>
                    </tr>
                `;
            });
            
            document.getElementById('ventaTotal').textContent = '$' + total.toFixed(2);
        }

        function saveVenta(e) {
            e.preventDefault();
            
            if (productosVentaTemp.length === 0) {
                showNotification('Agrega al menos un producto', 'error');
                return;
            }
            
            const total = productosVentaTemp.reduce((sum, item) => sum + (item.cantidad * item.precio), 0);
            const venta = {
                id: Date.now(),
                folio: 'VT-' + new Date().getFullYear() + '-' + String(DB.ventas.length + 1).padStart(3, '0'),
                fecha: document.getElementById('ventaFecha').value,
                clienteId: parseInt(document.getElementById('ventaCliente').value),
                productos: productosVentaTemp.map(p => ({productoId: p.productoId, cantidad: p.cantidad, precio: p.precio})),
                total: total,
                estado: document.getElementById('ventaEstado').value,
                metodoPago: document.getElementById('ventaMetodoPago').value,
                notas: document.getElementById('ventaNotas').value
            };
            
            productosVentaTemp.forEach(item => {
                const prod = DB.productos.find(p => p.id == item.productoId);
                prod.stock -= item.cantidad;
            });
            
            DB.ventas.push(venta);
            saveData();
            renderVentas();
            renderProductos();
            closeModal('venta');
            updateDashboard();
            addActivity(`Venta creada: ${venta.folio} - $${total.toFixed(2)} por ${currentUser.nombre}`);
            showNotification('Venta guardada correctamente', 'success');
        }

        function verVenta(id) {
            const v = DB.ventas.find(venta => venta.id == id);
            const cliente = DB.clientes.find(c => c.id == v.clienteId);
            
            let productosDetalle = v.productos.map(p => {
                const prod = DB.productos.find(prod => prod.id == p.productoId);
                return `- ${prod ? prod.nombre : 'Producto'}: ${p.cantidad} x $${p.precio.toFixed(2)} = $${(p.cantidad * p.precio).toFixed(2)}`;
            }).join('\n');
            
            alert(`VENTA ${v.folio}\n\nCliente: ${cliente ? cliente.nombre : 'N/A'}\nFecha: ${v.fecha}\nEstado: ${v.estado}\nM√©todo de pago: ${v.metodoPago}\n\nPRODUCTOS:\n${productosDetalle}\n\nTOTAL: $${v.total.toFixed(2)}`);
        }

        function cambiarEstadoVenta(id) {
            const v = DB.ventas.find(venta => venta.id == id);
            const estados = ['Pendiente', 'Pagado', 'Enviado'];
            const currentIndex = estados.indexOf(v.estado);
            const nextEstado = estados[(currentIndex + 1) % estados.length];
            
            v.estado = nextEstado;
            saveData();
            renderVentas();
            addActivity(`Venta ${v.folio} cambi√≥ a: ${nextEstado} por ${currentUser.nombre}`);
            showNotification(`Estado actualizado a: ${nextEstado}`, 'success');
        }

        function cancelarVenta(id) {
            if (!confirm('¬øCancelar esta venta? El stock ser√° devuelto al inventario.')) return;
            
            const v = DB.ventas.find(venta => venta.id == id);
            
            v.productos.forEach(item => {
                const prod = DB.productos.find(p => p.id == item.productoId);
                if (prod) prod.stock += item.cantidad;
            });
            
            v.estado = 'Cancelado';
            saveData();
            renderVentas();
            renderProductos();
            updateDashboard();
            addActivity(`Venta cancelada: ${v.folio} por ${currentUser.nombre}`);
            showNotification('Venta cancelada - Stock devuelto', 'info');
        }

        // ==================== COMPRAS ====================

        function addProductoCompra() {
            const prodId = document.getElementById('compraProdSelect').value;
            const cantidad = parseInt(document.getElementById('compraCantidad').value);
            const costo = parseFloat(document.getElementById('compraCosto').value);
            
            if (!prodId || !cantidad || !costo) {
                showNotification('Completa todos los campos', 'error');
                return;
            }
            
            const prod = DB.productos.find(p => p.id == prodId);
            
            productosCompraTemp.push({
                productoId: parseInt(prodId),
                nombre: prod.nombre,
                cantidad: cantidad,
                costo: costo
            });
            
            renderProductosCompra();
            document.getElementById('compraProdSelect').value = '';
            document.getElementById('compraCantidad').value = 1;
            document.getElementById('compraCosto').value = '';
        }

        function removeProductoCompra(index) {
            productosCompraTemp.splice(index, 1);
            renderProductosCompra();
        }

        function renderProductosCompra() {
            const tbody = document.querySelector('#tablaProductosCompra tbody');
            tbody.innerHTML = '';
            let total = 0;
            
            productosCompraTemp.forEach((item, index) => {
                const subtotal = item.cantidad * item.costo;
                total += subtotal;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.nombre}</td>
                        <td>${item.cantidad}</td>
                        <td>$${item.costo.toFixed(2)}</td>
                        <td>$${subtotal.toFixed(2)}</td>
                        <td><button type="button" class="btn-danger btn-small" onclick="removeProductoCompra(${index})">üóëÔ∏è</button></td>
                    </tr>
                `;
            });
            
            document.getElementById('compraTotal').textContent = '$' + total.toFixed(2);
        }

        function saveCompra(e) {
            e.preventDefault();
            
            if (productosCompraTemp.length === 0) {
                showNotification('Agrega al menos un producto', 'error');
                return;
            }
            
            const total = productosCompraTemp.reduce((sum, item) => sum + (item.cantidad * item.costo), 0);
            const compra = {
                id: Date.now(),
                folio: 'OC-' + new Date().getFullYear() + '-' + String(DB.compras.length + 1).padStart(3, '0'),
                fecha: document.getElementById('compraFecha').value,
                proveedorId: parseInt(document.getElementById('compraProveedor').value),
                productos: productosCompraTemp.map(p => ({productoId: p.productoId, cantidad: p.cantidad, costo: p.costo})),
                total: total,
                estado: document.getElementById('compraEstado').value,
                factura: document.getElementById('compraFactura').value
            };
            
            if (compra.estado === 'Recibido') {
                productosCompraTemp.forEach(item => {
                    const prod = DB.productos.find(p => p.id == item.productoId);
                    if (prod) {
                        prod.stock += item.cantidad;
                        const costoTotalActual = prod.costo * (prod.stock - item.cantidad);
                        const costoTotalNuevo = item.costo * item.cantidad;
                        prod.costo = (costoTotalActual + costoTotalNuevo) / prod.stock;
                    }
                });
            }
            
            DB.compras.push(compra);
            saveData();
            renderCompras();
            renderProductos();
            closeModal('compra');
            updateDashboard();
            addActivity(`Compra creada: ${compra.folio} - $${total.toFixed(2)} por ${currentUser.nombre}`);
            showNotification('Compra guardada correctamente', 'success');
        }

        function recibirCompra(id) {
            const compra = DB.compras.find(c => c.id == id);
            if (compra.estado === 'Recibido') {
                showNotification('Esta compra ya fue recibida', 'warning');
                return;
            }
            
            compra.productos.forEach(item => {
                const prod = DB.productos.find(p => p.id == item.productoId);
                if (prod) {
                    prod.stock += item.cantidad;
                    const costoTotalActual = prod.costo * prod.stock;
                    const costoTotalNuevo = item.costo * item.cantidad;
                    prod.costo = (costoTotalActual + costoTotalNuevo) / (prod.stock + item.cantidad);
                }
            });
            
            compra.estado = 'Recibido';
            saveData();
            renderCompras();
            renderProductos();
            updateDashboard();
            addActivity(`Compra recibida: ${compra.folio} por ${currentUser.nombre}`);
            showNotification('Compra marcada como recibida', 'success');
        }

        function deleteCompra(id) {
            if (confirm('¬øEliminar esta orden de compra?')) {
                const c = DB.compras.find(compra => compra.id == id);
                
                if (c.estado === 'Recibido') {
                    c.productos.forEach(item => {
                        const prod = DB.productos.find(p => p.id == item.productoId);
                        if (prod) prod.stock -= item.cantidad;
                    });
                }
                
                DB.compras = DB.compras.filter(compra => compra.id != id);
                saveData();
                renderCompras();
                renderProductos();
                updateDashboard();
                addActivity(`Compra eliminada: ${c.folio} por ${currentUser.nombre}`);
                showNotification('Compra eliminada', 'info');
            }
        }

        function verCompra(id) {
            const c = DB.compras.find(compra => compra.id == id);
            const prov = DB.proveedores.find(p => p.id == c.proveedorId);
            
            let productosDetalle = c.productos.map(p => {
                const prod = DB.productos.find(prod => prod.id == p.productoId);
                return `- ${prod ? prod.nombre : 'Producto'}: ${p.cantidad} x $${p.costo.toFixed(2)} = $${(p.cantidad * p.costo).toFixed(2)}`;
            }).join('\n');
            
            alert(`COMPRA ${c.folio}\n\nProveedor: ${prov ? prov.empresa : 'N/A'}\nFecha: ${c.fecha}\nEstado: ${c.estado}\nFactura: ${c.factura || 'N/A'}\n\nPRODUCTOS:\n${productosDetalle}\n\nTOTAL: $${c.total.toFixed(2)}`);
        }

        // ==================== CLIENTES ====================

        function saveCliente(e) {
            e.preventDefault();
            
            const id = document.getElementById('cliId').value;
            const cliente = {
                id: id ? parseInt(id) : Date.now(),
                nombre: document.getElementById('cliNombre').value,
                rfc: document.getElementById('cliRFC').value || '',
                contacto: document.getElementById('cliContacto').value || '',
                telefono: document.getElementById('cliTelefono').value,
                email: document.getElementById('cliEmail').value || '',
                credito: parseFloat(document.getElementById('cliCredito').value) || 0,
                saldo: 0,
                direccion: document.getElementById('cliDireccion').value || ''
            };
            
            if (id) {
                const index = DB.clientes.findIndex(c => c.id == id);
                cliente.saldo = DB.clientes[index].saldo || 0;
                DB.clientes[index] = cliente;
                addActivity(`Cliente actualizado: ${cliente.nombre} por ${currentUser.nombre}`);
            } else {
                DB.clientes.push(cliente);
                addActivity(`Cliente creado: ${cliente.nombre} por ${currentUser.nombre}`);
            }
            
            saveData();
            renderClientes();
            closeModal('cliente');
            updateDashboard();
            populateSelects();
            showNotification('Cliente guardado correctamente', 'success');
        }

        function editCliente(id) {
            const c = DB.clientes.find(c => c.id == id);
            if (!c) return;
            
            document.getElementById('cliId').value = c.id;
            document.getElementById('cliNombre').value = c.nombre;
            document.getElementById('cliRFC').value = c.rfc || '';
            document.getElementById('cliContacto').value = c.contacto || '';
            document.getElementById('cliTelefono').value = c.telefono;
            document.getElementById('cliEmail').value = c.email || '';
            document.getElementById('cliCredito').value = c.credito || 0;
            document.getElementById('cliDireccion').value = c.direccion || '';
            document.getElementById('tituloCliente').textContent = 'Editar Cliente';
            openModal('cliente');
        }

        function deleteCliente(id) {
            if (confirm('¬øEliminar este cliente?')) {
                const c = DB.clientes.find(c => c.id == id);
                const tieneVentas = DB.ventas.some(v => v.clienteId == id);
                if (tieneVentas) {
                    showNotification('No se puede eliminar: tiene ventas asociadas', 'error');
                    return;
                }
                
                DB.clientes = DB.clientes.filter(c => c.id != id);
                saveData();
                renderClientes();
                updateDashboard();
                populateSelects();
                addActivity(`Cliente eliminado: ${c.nombre} por ${currentUser.nombre}`);
                showNotification('Cliente eliminado', 'info');
            }
        }

        function verCliente(id) {
            const c = DB.clientes.find(c => c.id == id);
            const ventasCliente = DB.ventas.filter(v => v.clienteId == id && v.estado !== 'Cancelado');
            const totalComprado = ventasCliente.reduce((sum, v) => sum + v.total, 0);
            
            alert(`CLIENTE: ${c.nombre}\n\nRFC: ${c.rfc || 'N/A'}\nContacto: ${c.contacto || 'N/A'}\nTel√©fono: ${c.telefono}\nEmail: ${c.email || 'N/A'}\nDirecci√≥n: ${c.direccion || 'N/A'}\n\nL√≠mite de cr√©dito: $${(c.credito || 0).toFixed(2)}\nSaldo actual: $${(c.saldo || 0).toFixed(2)}\n\nTotal comprado: $${totalComprado.toFixed(2)}\nN√∫mero de compras: ${ventasCliente.length}`);
        }

        // ==================== PROVEEDORES ====================

        function saveProveedor(e) {
            e.preventDefault();
            
            const id = document.getElementById('provId').value;
            const proveedor = {
                id: id ? parseInt(id) : Date.now(),
                empresa: document.getElementById('provEmpresa').value,
                rfc: document.getElementById('provRFC').value || '',
                contacto: document.getElementById('provContacto').value || '',
                telefono: document.getElementById('provTelefono').value,
                email: document.getElementById('provEmail').value || '',
                diasCredito: parseInt(document.getElementById('provDiasCredito').value) || 0,
                direccion: document.getElementById('provDireccion').value || ''
            };
            
            if (id) {
                const index = DB.proveedores.findIndex(p => p.id == id);
                DB.proveedores[index] = proveedor;
                addActivity(`Proveedor actualizado: ${proveedor.empresa} por ${currentUser.nombre}`);
            } else {
                DB.proveedores.push(proveedor);
                addActivity(`Proveedor creado: ${proveedor.empresa} por ${currentUser.nombre}`);
            }
            
            saveData();
            renderProveedores();
            closeModal('proveedor');
            populateSelects();
            showNotification('Proveedor guardado correctamente', 'success');
        }

        function editProveedor(id) {
            const p = DB.proveedores.find(p => p.id == id);
            if (!p) return;
            
            document.getElementById('provId').value = p.id;
            document.getElementById('provEmpresa').value = p.empresa;
            document.getElementById('provRFC').value = p.rfc || '';
            document.getElementById('provContacto').value = p.contacto || '';
            document.getElementById('provTelefono').value = p.telefono;
            document.getElementById('provEmail').value = p.email || '';
            document.getElementById('provDiasCredito').value = p.diasCredito || 0;
            document.getElementById('provDireccion').value = p.direccion || '';
            document.getElementById('tituloProveedor').textContent = 'Editar Proveedor';
            openModal('proveedor');
        }

        function deleteProveedor(id) {
            if (confirm('¬øEliminar este proveedor?')) {
                const p = DB.proveedores.find(p => p.id == id);
                const tieneCompras = DB.compras.some(c => c.proveedorId == id);
                if (tieneCompras) {
                    showNotification('No se puede eliminar: tiene compras asociadas', 'error');
                    return;
                }
                
                DB.proveedores = DB.proveedores.filter(p => p.id != id);
                saveData();
                renderProveedores();
                populateSelects();
                addActivity(`Proveedor eliminado: ${p.empresa} por ${currentUser.nombre}`);
                showNotification('Proveedor eliminado', 'info');
            }
        }

        // ==================== RENDERIZADO ====================

        function renderAllTables() {
            renderProductos();
            renderVentas();
            renderCompras();
            renderClientes();
            renderProveedores();
        }

        function renderProductos() {
            const tbody = document.querySelector('#tablaProductos tbody');
            const search = document.getElementById('searchProducto').value.toLowerCase();
            const categoria = document.getElementById('filterCategoria').value;
            
            tbody.innerHTML = '';
            
            const filtrados = DB.productos.filter(p => {
                const matchSearch = p.nombre.toLowerCase().includes(search) || 
                                   p.codigo.toLowerCase().includes(search) ||
                                   (p.descripcion && p.descripcion.toLowerCase().includes(search));
                const matchCat = !categoria || p.categoria === categoria;
                return matchSearch && matchCat;
            });
            
            filtrados.forEach(p => {
                const stockStatus = p.stock <= p.stockMin ? 'danger' : 
                                   p.stock <= p.stockMin * 1.5 ? 'warning' : 'success';
                const stockText = p.stock <= p.stockMin ? 'Cr√≠tico' : 
                                 p.stock <= p.stockMin * 1.5 ? 'Bajo' : 'OK';
                const stockClass = p.stock <= p.stockMin ? 'low-stock' : '';
                
                const utilidad = ((p.precio - p.costo) / p.precio * 100).toFixed(1);
                
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${p.codigo}</strong></td>
                        <td>${p.nombre}<br><small style="color:#999">${p.descripcion || ''}</small></td>
                        <td>${p.categoria}</td>
                        <td class="${stockClass}">${p.stock} ${p.unidad}</td>
                        <td>${p.stockMin}</td>
                        <td>$${p.costo.toFixed(2)}</td>
                        <td>$${p.precio.toFixed(2)}<br><small style="color:#27ae60">${utilidad}% margen</small></td>
                        <td><span class="badge badge-${stockStatus}">${stockText}</span></td>
                        <td class="actions">
                            <button class="btn-primary btn-small" onclick="editProducto(${p.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-danger btn-small" onclick="deleteProducto(${p.id})" title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            const cats = [...new Set(DB.productos.map(p => p.categoria))].sort();
            const select = document.getElementById('filterCategoria');
            const currentVal = select.value;
            select.innerHTML = '<option value="">Todas las categor√≠as</option>';
            cats.forEach(c => {
                select.innerHTML += `<option value="${c}">${c}</option>`;
            });
            select.value = currentVal;
        }

        function renderVentas() {
            const tbody = document.querySelector('#tablaVentas tbody');
            const search = document.getElementById('searchVenta').value.toLowerCase();
            const estado = document.getElementById('filterEstadoVenta').value;
            const fechaDesde = document.getElementById('filterFechaDesde').value;
            const fechaHasta = document.getElementById('filterFechaHasta').value;
            
            tbody.innerHTML = '';
            let totalFiltrado = 0;
            
            const filtradas = DB.ventas.filter(v => {
                const cliente = DB.clientes.find(c => c.id == v.clienteId);
                const matchSearch = v.folio.toLowerCase().includes(search) || 
                                   (cliente && cliente.nombre.toLowerCase().includes(search)) ||
                                   v.metodoPago.toLowerCase().includes(search);
                const matchEstado = !estado || v.estado === estado;
                const matchFecha = (!fechaDesde || v.fecha >= fechaDesde) && 
                                  (!fechaHasta || v.fecha <= fechaHasta);
                return matchSearch && matchEstado && matchFecha;
            });
            
            filtradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            filtradas.forEach(v => {
                const cliente = DB.clientes.find(c => c.id == v.clienteId);
                totalFiltrado += v.total;
                
                const estadoClass = {
                    'Pagado': 'success',
                    'Pendiente': 'warning',
                    'Enviado': 'info',
                    'Cancelado': 'danger'
                }[v.estado] || 'secondary';
                
                tbody.innerHTML += `
                    <tr style="${v.estado === 'Cancelado' ? 'opacity:0.6;text-decoration:line-through' : ''}">
                        <td><strong>${v.folio}</strong></td>
                        <td>${v.fecha}</td>
                        <td>${cliente ? cliente.nombre : 'N/A'}</td>
                        <td>${v.productos.length} productos</td>
                        <td>$${v.total.toFixed(2)}</td>
                        <td><span class="badge badge-${estadoClass}">${v.estado}</span></td>
                        <td class="actions">
                            <button class="btn-primary btn-small" onclick="verVenta(${v.id})" title="Ver detalle">üëÅÔ∏è</button>
                            ${v.estado !== 'Cancelado' ? `
                                <button class="btn-warning btn-small" onclick="cambiarEstadoVenta(${v.id})" title="Cambiar estado">üîÑ</button>
                                <button class="btn-danger btn-small" onclick="cancelarVenta(${v.id})" title="Cancelar">‚ùå</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('totalVentasFiltradas').textContent = '$' + totalFiltrado.toFixed(2);
        }

        function renderCompras() {
            const tbody = document.querySelector('#tablaCompras tbody');
            const search = document.getElementById('searchCompra').value.toLowerCase();
            const estado = document.getElementById('filterEstadoCompra').value;
            
            tbody.innerHTML = '';
            let totalFiltrado = 0;
            
            const filtradas = DB.compras.filter(c => {
                const prov = DB.proveedores.find(p => p.id == c.proveedorId);
                const matchSearch = c.folio.toLowerCase().includes(search) || 
                                   (prov && prov.empresa.toLowerCase().includes(search)) ||
                                   (c.factura && c.factura.toLowerCase().includes(search));
                const matchEstado = !estado || c.estado === estado;
                return matchSearch && matchEstado;
            });
            
            filtradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            filtradas.forEach(c => {
                const prov = DB.proveedores.find(p => p.id == c.proveedorId);
                totalFiltrado += c.total;
                
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${c.folio}</strong></td>
                        <td>${c.fecha}</td>
                        <td>${prov ? prov.empresa : 'N/A'}</td>
                        <td>${c.productos.length} productos</td>
                        <td>$${c.total.toFixed(2)}</td>
                        <td><span class="badge badge-${c.estado === 'Recibido' ? 'success' : 'warning'}">${c.estado}</span></td>
                        <td class="actions">
                            <button class="btn-primary btn-small" onclick="verCompra(${c.id})" title="Ver">üëÅÔ∏è</button>
                            ${c.estado === 'Pendiente' ? `
                                <button class="btn-success btn-small" onclick="recibirCompra(${c.id})" title="Marcar recibida">üì¶</button>
                                <button class="btn-danger btn-small" onclick="deleteCompra(${c.id})" title="Eliminar">üóëÔ∏è</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('totalComprasFiltradas').textContent = '$' + totalFiltrado.toFixed(2);
        }

        function renderClientes() {
            const tbody = document.querySelector('#tablaClientes tbody');
            const search = document.getElementById('searchCliente').value.toLowerCase();
            
            tbody.innerHTML = '';
            
            DB.clientes.filter(c => {
                return c.nombre.toLowerCase().includes(search) || 
                       c.telefono.includes(search) ||
                       (c.email && c.email.toLowerCase().includes(search)) ||
                       (c.rfc && c.rfc.toLowerCase().includes(search));
            }).forEach(c => {
                tbody.innerHTML += `
                    <tr>
                        <td>CLI-${String(c.id).padStart(3, '0')}</td>
                        <td><strong>${c.nombre}</strong><br><small>${c.rfc || ''}</small></td>
                        <td>${c.contacto || '-'}</td>
                        <td>${c.telefono}</td>
                        <td>${c.email || '-'}</td>
                        <td>$${(c.credito || 0).toFixed(2)}</td>
                        <td>$${(c.saldo || 0).toFixed(2)}</td>
                        <td class="actions">
                            <button class="btn-primary btn-small" onclick="verCliente(${c.id})" title="Ver">üëÅÔ∏è</button>
                            <button class="btn-primary btn-small" onclick="editCliente(${c.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-danger btn-small" onclick="deleteCliente(${c.id})" title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderProveedores() {
            const tbody = document.querySelector('#tablaProveedores tbody');
            const search = document.getElementById('searchProveedor').value.toLowerCase();
            
            tbody.innerHTML = '';
            
            DB.proveedores.filter(p => {
                return p.empresa.toLowerCase().includes(search) ||
                       p.telefono.includes(search) ||
                       (p.contacto && p.contacto.toLowerCase().includes(search));
            }).forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>PROV-${String(p.id).padStart(3, '0')}</td>
                        <td><strong>${p.empresa}</strong><br><small>${p.rfc || ''}</small></td>
                        <td>${p.contacto || '-'}</td>
                        <td>${p.telefono}</td>
                        <td>${p.email || '-'}</td>
                        <td>${p.direccion || '-'}</td>
                        <td class="actions">
                            <button class="btn-primary btn-small" onclick="editProveedor(${p.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-danger btn-small" onclick="deleteProveedor(${p.id})" title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderUsuarios() {
            const tbody = document.getElementById('tablaUsuarios');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            DB.usuarios.forEach(u => {
                tbody.innerHTML += `
                    <tr>
                        <td>${u.nombre}</td>
                        <td>${u.email}</td>
                        <td>${u.rol}</td>
                        <td><span class="badge badge-success">Activo</span></td>
                    </tr>
                `;
            });
        }

        // ==================== UTILIDADES ====================

        function populateSelects() {
            const selCliente = document.getElementById('ventaCliente');
            selCliente.innerHTML = '<option value="">Seleccionar cliente...</option>';
            DB.clientes.forEach(c => {
                selCliente.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
            });
            
            const selProv = document.getElementById('compraProveedor');
            selProv.innerHTML = '<option value="">Seleccionar proveedor...</option>';
            DB.proveedores.forEach(p => {
                selProv.innerHTML += `<option value="${p.id}">${p.empresa}</option>`;
            });
            
            const selProdVenta = document.getElementById('ventaProdSelect');
            selProdVenta.innerHTML = '<option value="">Seleccionar...</option>';
            DB.productos.filter(p => p.stock > 0).forEach(p => {
                selProdVenta.innerHTML += `<option value="${p.id}">${p.nombre} (Stock: ${p.stock})</option>`;
            });
            
            const selProdCompra = document.getElementById('compraProdSelect');
            selProdCompra.innerHTML = '<option value="">Seleccionar...</option>';
            DB.productos.forEach(p => {
                selProdCompra.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
        }

        function filterTable(tipo) {
            if (tipo === 'productos') renderProductos();
            else if (tipo === 'ventas') renderVentas();
            else if (tipo === 'compras') renderCompras();
            else if (tipo === 'clientes') renderClientes();
            else if (tipo === 'proveedores') renderProveedores();
        }

        function updateDashboard() {
            const totalVentas = DB.ventas.filter(v => v.estado !== 'Cancelado').reduce((sum, v) => sum + v.total, 0);
            const totalCompras = DB.compras.reduce((sum, c) => sum + c.total, 0);
            
            document.getElementById('totalVentas').textContent = '$' + totalVentas.toFixed(2);
            document.getElementById('totalCompras').textContent = '$' + totalCompras.toFixed(2);
            document.getElementById('totalProductos').textContent = DB.productos.length;
            document.getElementById('totalClientes').textContent = DB.clientes.length;
            
            const lowStock = DB.productos.filter(p => p.stock <= p.stockMin);
            const lowStockDiv = document.getElementById('lowStockList');
            if (lowStock.length > 0) {
                lowStockDiv.innerHTML = lowStock.map(p => `
                    <div style="padding: 10px; background: #fff3cd; margin-bottom: 5px; border-radius: 5px; border-left: 3px solid #f39c12;">
                        <strong>${p.nombre}</strong><br>
                        <small>Stock: ${p.stock} / M√≠n: ${p.stockMin}</small>
                    </div>
                `).join('');
            } else {
                lowStockDiv.innerHTML = '<div class="empty-state">No hay productos con stock bajo</div>';
            }
            
            renderActivity();
        }

        function addActivity(descripcion) {
            DB.actividad.unshift({
                fecha: new Date().toISOString(),
                descripcion: descripcion,
                usuario: currentUser ? currentUser.nombre : 'Sistema'
            });
            if (DB.actividad.length > 50) DB.actividad.pop();
            saveData();
            renderActivity();
        }

        function renderActivity() {
            const div = document.getElementById('activityList');
            if (DB.actividad.length === 0) {
                div.innerHTML = '<div class="empty-state">No hay actividad reciente</div>';
                return;
            }
            
            div.innerHTML = DB.actividad.slice(0, 10).map(a => `
                <div class="activity-item">
                    ${a.descripcion}
                    <small>${new Date(a.fecha).toLocaleString()} - ${a.usuario}</small>
                </div>
            `).join('');
        }

        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.remove();
            }, 3000);
        }

        // ==================== GR√ÅFICOS ====================

        function initCharts() {
            // Destruir gr√°ficos existentes
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // Gr√°fico Ventas vs Compras
            const ctx1 = document.getElementById('chartVentasCompras');
            if (ctx1) {
                charts.ventasCompras = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Ventas',
                            data: [12500, 19000, 15000, 22000, 18000, 24000],
                            backgroundColor: '#1e3c72'
                        }, {
                            label: 'Compras',
                            data: [8000, 12000, 10000, 15000, 11000, 16000],
                            backgroundColor: '#e74c3c'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico Productos por Categor√≠a
            const ctx2 = document.getElementById('chartCategorias');
            if (ctx2) {
                const categorias = {};
                DB.productos.forEach(p => {
                    categorias[p.categoria] = (categorias[p.categoria] || 0) + 1;
                });
                
                charts.categorias = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categorias),
                        datasets: [{
                            data: Object.values(categorias),
                            backgroundColor: ['#1e3c72', '#3498db', '#27ae60', '#f39c12', '#e74c3c', '#9b59b6', '#1abc9c']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Gr√°fico Financiero
            const ctx3 = document.getElementById('chartFinanciero');
            if (ctx3) {
                charts.financiero = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Utilidad',
                            data: [4500, 7000, 5000, 7000, 7000, 8000],
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico Stock
            const ctx4 = document.getElementById('chartStock');
            if (ctx4) {
                const productosStock = DB.productos.slice(0, 5);
                charts.stock = new Chart(ctx4, {
                    type: 'bar',
                    data: {
                        labels: productosStock.map(p => p.nombre.substring(0, 15)),
                        datasets: [{
                            label: 'Stock Actual',
                            data: productosStock.map(p => p.stock),
                            backgroundColor: '#3498db'
                        }, {
                            label: 'Stock M√≠nimo',
                            data: productosStock.map(p => p.stockMin),
                            backgroundColor: '#e74c3c'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y'
                    }
                });
            }
        }

        // ==================== REPORTES ====================

        function showReportTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.report-section').forEach(s => s.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById('report-' + tab).style.display = 'block';
            
            if (tab === 'ventas' || tab === 'resumen') {
                setTimeout(() => {
                    const ctx = document.getElementById('chartTendencia');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                                datasets: [{
                                    label: 'Ventas Semanales',
                                    data: [5000, 7000, 6500, 8000],
                                    borderColor: '#1e3c72',
                                    backgroundColor: 'rgba(30, 60, 114, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                    
                    const ctxPie = document.getElementById('chartPieVentas');
                    if (ctxPie) {
                        new Chart(ctxPie, {
                            type: 'pie',
                            data: {
                                labels: ['Ferreter√≠a', 'El√©ctrico', 'Herramientas', 'Otros'],
                                datasets: [{
                                    data: [35, 25, 20, 20],
                                    backgroundColor: ['#1e3c72', '#3498db', '#27ae60', '#f39c12']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                }, 100);
            }
        }

        function updateReportes() {
            const ventasValidas = DB.ventas.filter(v => v.estado !== 'Cancelado');
            const totalVentas = ventasValidas.reduce((sum, v) => sum + v.total, 0);
            
            let totalCostos = 0;
            ventasValidas.forEach(v => {
                v.productos.forEach(p => {
                    const prod = DB.productos.find(prod => prod.id == p.productoId);
                    if (prod) {
                        totalCostos += prod.costo * p.cantidad;
                    }
                });
            });
            
            const utilidad = totalVentas - totalCostos;
            const margen = totalVentas > 0 ? (utilidad / totalVentas * 100) : 0;
            const ticketPromedio = ventasValidas.length > 0 ? totalVentas / ventasValidas.length : 0;
            const valorInventario = DB.productos.reduce((sum, p) => sum + (p.stock * p.costo), 0);
            const rotacion = valorInventario > 0 ? (totalCostos / valorInventario) : 0;
            
            document.getElementById('utilidadBruta').textContent = '$' + utilidad.toFixed(2);
            document.getElementById('margenGanancia').textContent = margen.toFixed(1) + '%';
            document.getElementById('rotacionInventario').textContent = rotacion.toFixed(2);
            document.getElementById('ticketPromedio').textContent = '$' + ticketPromedio.toFixed(2);
            
            const totalCompras = DB.compras.reduce((sum, c) => sum + c.total, 0);
            const gastosOperativos = totalCompras * 0.1;
            const utilidadNeta = utilidad - gastosOperativos;
            
            document.getElementById('finVentas').textContent = '$' + totalVentas.toFixed(2);
            document.getElementById('finCostos').textContent = '$' + totalCostos.toFixed(2);
            document.getElementById('finUtilidad').textContent = '$' + utilidad.toFixed(2);
            document.getElementById('finGastos').textContent = '$' + gastosOperativos.toFixed(2);
            document.getElementById('finNeto').textContent = '$' + utilidadNeta.toFixed(2);
            
            const tbodyVentas = document.querySelector('#tablaReporteVentas tbody');
            tbodyVentas.innerHTML = '';
            
            const ventasPorMes = {};
            ventasValidas.forEach(v => {
                const mes = v.fecha.substring(0, 7);
                if (!ventasPorMes[mes]) {
                    ventasPorMes[mes] = { count: 0, total: 0 };
                }
                ventasPorMes[mes].count++;
                ventasPorMes[mes].total += v.total;
            });
            
            Object.entries(ventasPorMes).sort().reverse().forEach(([mes, data], index, array) => {
                const promedio = data.total / data.count;
                let crecimiento = 0;
                if (index < array.length - 1) {
                    const mesAnterior = array[index + 1][1];
                    crecimiento = ((data.total - mesAnterior.total) / mesAnterior.total * 100);
                }
                
                tbodyVentas.innerHTML += `
                    <tr>
                        <td>${mes}</td>
                        <td>${data.count}</td>
                        <td>$${data.total.toFixed(2)}</td>
                        <td>$${promedio.toFixed(2)}</td>
                        <td style="color: ${crecimiento >= 0 ? '#27ae60' : '#e74c3c'}">
                            ${crecimiento > 0 ? '+' : ''}${crecimiento.toFixed(1)}%
                        </td>
                    </tr>
                `;
            });
            
            const tbodyInv = document.querySelector('#tablaReporteInventario tbody');
            tbodyInv.innerHTML = '';
            let valorTotalInventario = 0;
            
            const categorias = {};
            DB.productos.forEach(p => {
                if (!categorias[p.categoria]) {
                    categorias[p.categoria] = { count: 0, stock: 0, costo: 0, venta: 0 };
                }
                categorias[p.categoria].count++;
                categorias[p.categoria].stock += p.stock;
                const valorCosto = p.stock * p.costo;
                const valorVenta = p.stock * p.precio;
                categorias[p.categoria].costo += valorCosto;
                categorias[p.categoria].venta += valorVenta;
                valorTotalInventario += valorCosto;
            });
            
            Object.entries(categorias).forEach(([cat, data]) => {
                tbodyInv.innerHTML += `
                    <tr>
                        <td><strong>${cat}</strong></td>
                        <td>${data.count}</td>
                        <td>${data.stock}</td>
                        <td>$${data.costo.toFixed(2)}</td>
                        <td>$${data.venta.toFixed(2)}<br><small style="color:#27ae60">+$${(data.venta - data.costo).toFixed(2)}</small></td>
                    </tr>
                `;
            });
            
            document.getElementById('valorTotalInventario').textContent = '$' + valorTotalInventario.toFixed(2);
        }

        function generateReport(tipo) {
            showNotification(`Generando reporte de ${tipo}...`, 'info');
            setTimeout(() => {
                window.print();
            }, 500);
        }

        // ==================== CONFIGURACI√ìN ====================

        function saveConfig() {
            DB.config.nombreEmpresa = document.getElementById('configNombreEmpresa').value;
            DB.config.rfc = document.getElementById('configRFC').value;
            DB.config.direccion = document.getElementById('configDireccion').value;
            DB.config.telefono = document.getElementById('configTelefono').value;
            DB.config.email = document.getElementById('configEmail').value;
            DB.config.impuesto = parseFloat(document.getElementById('configImpuesto').value);
            
            saveData();
            addActivity('Configuraci√≥n actualizada por ' + currentUser.nombre);
            showNotification('Configuraci√≥n guardada', 'success');
        }

        function backupData() {
            const dataStr = JSON.stringify(DB, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `erp_gpo4p_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('Respaldo descargado', 'success');
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.assign(DB, data);
                    saveData();
                    renderAllTables();
                    updateDashboard();
                    populateSelects();
                    renderUsuarios();
                    showNotification('Datos restaurados correctamente', 'success');
                    addActivity('Datos restaurados desde archivo por ' + currentUser.nombre);
                } catch (err) {
                    showNotification('Error al restaurar datos', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('¬øEST√ÅS SEGURO? Se borrar√°n TODOS los datos permanentemente.')) {
                if (confirm('¬øRealmente deseas borrar todo? Esta acci√≥n no se puede deshacer.')) {
                    localStorage.removeItem('erp_data_gpo4p');
                    location.reload();
                }
            }
        }

        function exportData(tipo) {
            let data, filename;
            
            if (tipo === 'productos') {
                data = DB.productos;
                filename = 'productos_gpo4p.csv';
            } else if (tipo === 'clientes') {
                data = DB.clientes;
                filename = 'clientes_gpo4p.csv';
            } else if (tipo === 'reporteVentas') {
                const ventasValidas = DB.ventas.filter(v => v.estado !== 'Cancelado');
                data = ventasValidas.map(v => {
                    const cliente = DB.clientes.find(c => c.id == v.clienteId);
                    return {
                        folio: v.folio,
                        fecha: v.fecha,
                        cliente: cliente ? cliente.nombre : 'N/A',
                        productos: v.productos.length,
                        total: v.total,
                        estado: v.estado,
                        metodoPago: v.metodoPago
                    };
                });
                filename = 'reporte_ventas_gpo4p.csv';
            }
            
            let csv = Object.keys(data[0] || {}).join(',') + '\n';
            data.forEach(row => {
                csv += Object.values(row).map(v => `"${v}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            showNotification('Archivo exportado correctamente', 'success');
        }

        // ==================== INICIALIZACI√ìN ====================

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        if (document.getElementById('loginScreen').classList.contains('hidden')) {
            init();
        }
    </script>
</body>
</html>
